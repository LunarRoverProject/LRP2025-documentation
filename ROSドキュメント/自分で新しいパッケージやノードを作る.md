## ROS2 の主要概念と Python ノードの実行方法

### 1. ワークスペース (Workspace)

ROS2 における**ワークスペース**は、複数の ROS2 パッケージをまとめて開発、ビルド、インストールするためのディレクトリのことです。特定のプロジェクトに関連するパッケージ群を一箇所に集約し、依存関係を管理しやすくする役割があります。

**主な特徴:**

- **ソース空間 (Source Space):** 開発中のパッケージのソースコードが置かれるディレクトリ（通常は `src` フォルダ）。
- **ビルド空間 (Build Space):** ビルドプロセス中に生成される中間ファイルが格納されるディレクトリ（通常は `build` フォルダ）。
- **インストール空間 (Install Space):** ビルドされた実行ファイル、ライブラリ、設定ファイルなどが最終的にインストールされるディレクトリ（通常は `install` フォルダ）。この空間が ROS2 環境に「オーバーレイ」されることで、パッケージ内のノードなどを実行できるようになります。

**一般的なワークスペースの構造例:**

```
my_ros2_workspace/
├── src/
│   ├── my_robot_package/
│   │   ├── src/
│   │   │   └── my_node.py
│   │   ├── package.xml
│   │   └── setup.py
│   └── another_ros2_package/
│       ├── ...
├── build/
├── install/
└── log/
```

### 2. パッケージ (Package)

**パッケージ**は、ROS2 アプリケーションを構成する最小のビルド可能な単位です。ノード、ライブラリ、設定ファイル、メッセージ定義、サービス定義、起動ファイルなど、特定の機能やロボットのモジュールをまとめたものです。

**主な特徴:**

- **再利用性:** 特定の機能をパッケージとしてカプセル化することで、他のプロジェクトで簡単に再利用できます。
- **依存関係の管理:** 各パッケージは、`package.xml` というファイルで他のパッケージへの依存関係を宣言します。これにより、ビルドシステムが適切なライブラリやヘッダファイルを自動的に解決します。
- **ビルドシステム:** ROS2 では `colcon` というビルドツールが使用され、パッケージ単位でビルドが行われます。

**パッケージの基本的な構成要素:**

- `package.xml`: パッケージのメタデータ（名前、バージョン、作者、依存関係など）を定義する必須ファイル。
- `CMakeLists.txt` (C++パッケージの場合) または `setup.py` (Python パッケージの場合): ビルドプロセスを定義するファイル。
- `src/`: ソースコード（ノードの実行ファイルなど）が格納されるディレクトリ。

### 3. ノード (Node)

**ノード**は、ROS2 システム内で実行される独立したプロセス（プログラム）のことです。それぞれのノードは特定のタスク（例: センサーデータの読み取り、モーターの制御、ナビゲーションの計算など）を実行し、他のノードと連携して複雑なロボットシステムを構築します。

**主な特徴:**

- **モジュール性:** 各ノードは単一の責任を持つように設計されることが推奨されます。これにより、システムのデバッグや拡張が容易になります。
- **通信:** ノード間は主に以下のメカニズムで通信します。
  - **トピック (Topic):** 一方向の非同期データストリーム（Publisher/Subscriber モデル）。例: センサーデータ、速度コマンド。
  - **サービス (Service):** リクエスト-レスポンス型の同期通信。例: 特定の計算の要求、ロボットの状態取得。
  - **アクション (Action):** 長時間かかるタスクのリクエストと、その途中のフィードバック、最終結果の取得。
- **名前空間 (Namespace):** ノード名やトピック名を階層的に整理するために使用されます。

**ノードの実行:**
ノードは通常、`ros2 run <package_name> <executable_name>` コマンドで実行されます。または、`ros2 launch` ファイルを使用して複数のノードを同時に起動することもできます。

### 4. Python コードを Setup に登録し、実行できるようにする方法

Python で書かれた ROS2 ノードを実行可能にするためには、以下の手順が必要です。

1.  **ROS2 パッケージの作成:**
    まず、Python ノードを含む ROS2 パッケージを作成します。

    ```bash
    cd my_ros2_workspace/src
    ros2 pkg create --build-type ament_python my_python_package
    ```

    これにより、`my_python_package`というディレクトリが作成され、中に`package.xml`と`setup.py`が含まれます。

2.  **Python ノードの作成:**
    `my_python_package/my_python_package/` ディレクトリ（通常、パッケージ名と同じ名前のサブディレクトリが Python モジュールとして作成されます）の中に Python スクリプトを作成します。例えば、`my_python_package/my_python_package/my_node.py` というファイルを作成し、以下の内容を記述します。

    ```python
    import rclpy
    from rclpy.node import Node

    class MySimpleNode(Node):
        def __init__(self):
            super().__init__('my_simple_node')
            self.get_logger().info('My Simple Node has been started!')

    def main(args=None):
        rclpy.init(args=args)
        node = MySimpleNode()
        rclpy.spin(node)
        node.destroy_node()
        rclpy.shutdown()

    if __name__ == '__main__':
        main()
    ```

3.  **`setup.py` の設定:**
    作成した Python ノードを実行可能にするために、`my_python_package/setup.py` を編集し、`entry_points` セクションにノードのエントリーポイントを記述します。

    デフォルトの `setup.py` の `setup()` 関数内にある `entry_points` のコメントアウトを外し、以下のように追記します。

    ```python
    from setuptools import find_packages, setup

    package_name = 'my_python_package'

    setup(
        name=package_name,
        version='0.0.0',
        packages=find_packages(exclude=['test']),
        data_files=[
            ('share/ament_index/resource_index/packages',
                ['resource/' + package_name]),
            ('share/' + package_name, ['package.xml']),
        ],
        install_requires=['setuptools'],
        zip_safe=True,
        maintainer='Your Name',
        maintainer_email='your.email@example.com',
        description='TODO: Package description',
        license='TODO: License declaration',
        tests_require=['pytest'],
        entry_points={
            'console_scripts': [
                'my_node = my_python_package.my_node:main', # ここに追記
            ],
        },
    )
    ```

    - `'my_node'`: 実行可能コマンド名。これが `ros2 run` の際に使用する名前になります。
    - `my_python_package.my_node:main`: パッケージ名`.`Python ファイル名` :``main `関数。これは、`my_python_package` ディレクトリ内の `my_node.py` ファイルの `main()` 関数を実行するという意味です。

4.  **ワークスペースのビルド:**
    ワークスペースのルートディレクトリに戻り、`colcon build` コマンドを実行してパッケージをビルドします。

    ```bash
    cd ~/my_ros2_workspace # ワークスペースのルートディレクトリ
    colcon build --packages-select my_python_package # 特定のパッケージのみビルド
    # または colcon build # ワークスペース内の全てのパッケージをビルド
    ```

5.  **環境設定のソース (Source):**
    ビルドが成功したら、ビルド成果物を現在のシェルに認識させるために、ワークスペースの `install` ディレクトリにある設定ファイルをソースします。

    ```bash
    source install/setup.bash
    ```

    - **重要:** この操作は新しいターミナルを開くたびに、または環境変数に永続的に追加されていない限り、毎回行う必要があります。

6.  **ノードの実行:**
    これで、Python ノードを実行する準備が整いました。

    ```bash
    ros2 run my_python_package my_node
    ```

    上記コマンドを実行すると、`My Simple Node has been started!` というメッセージが表示され、ノードが実行されます。

この手順を通じて、ROS2 の基本的な開発ワークフローと、Python ノードを ROS2 システムに組み込む方法を理解できます。
